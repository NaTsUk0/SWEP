import importlib
import json
import os
import lib.db.db

# Believe in yourself , there's no bugs.
# All the bugs is fault by user.
# Now pray. GL.

class ExploitHandler():
    def __init__(self):
        self.ExploitList = None
        self.Path = os.path.dirname(os.path.abspath(__file__))
        self.LoadJson() # Legacy code for compatibility. Better don't use this.


    def LoadJson(self):
        try:
            PayloadList = json.load(open('%s/../exp/explist.json' %(self.Path)))
            self.ExploitList = PayloadList['exploit']
        except Exception, e:
            print '[!] Failed to load payload file: %s' %(str(e))


    def FetchExp(self, name):
        try:
            self.Exploit = None
            for item in self.ExploitList:
                if name == item['id'] or name == item['file']:
                    try:
                        self.Exploit = importlib.import_module('lib.exp.%s' % (item['file']))
                        print '[+] Module load success.'
                    except Exception, e:
                        print '[!] Failed to load module: %s' % (str(e))
        except Exception, e:
            print '[!] Failed to load module: %s' % (str(e))
        return self.Exploit


    def FindExp(self, name):
        ExpList = []
        try:
            for item in self.ExploitList:
                if name in item['file'] or name == item['id'] or name in item['name']:
                    ExpList.append(item)
            if not ExpList:
                print '[*] Exploit not found.'
                return
            print '[+] Incoming exploit list: '
            print '[+] Total %s exploit(s).' %(len(ExpList))
            print 'ID       NAME                DESCRIPTION'
            print '--       ----                -----------'
            for item in ExpList:
                print item['id'].ljust(9, ' ') + item['file'].ljust(20) + item['name']
        except Exception, e:
            print '[!] Failed to fetch exploit list: %s' %(str(e))


    def LoadDatabase(self):
        pass